name: iOS Expo Build

on:
  workflow_run:
    workflows: ["Expo Fingerprint Check"]
    types: [completed]
  workflow_dispatch: # Allows you to trigger the workflow manually from the Actions tab

jobs:
  ios-expo-build:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: macos-15
    timeout-minutes: 90
    env:
      EXPO_BUILD_CACHE_UPLOAD: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup repository environment
        uses: ./.github/actions/setup-repo-environment
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Download needs_ios_build artifact
        uses: actions/download-artifact@v4
        with:
          name: needs_ios_build
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Check if build is needed
        id: check-build
        run: |
          NEEDS_BUILD=$(cat needs_ios_build.txt)
          echo "needs_build=$NEEDS_BUILD" >> $GITHUB_OUTPUT
          echo "iOS build needed: $NEEDS_BUILD"
          if [ "$NEEDS_BUILD" = "false" ]; then
            echo "‚úÖ iOS build not needed, exiting early"
            exit 0
          fi

      - name: Setup JavaScript environment
        uses: ./.github/actions/setup-javascript-environment

      - name: Setup Ruby
        uses: ./.github/actions/setup-ruby

      - name: Install Ruby dependencies
        run: bundle install

      - name: Setup iOS environment
        uses: ./.github/actions/setup-ios-environment

      - name: Set up env for ci
        run: touch .env.shared && touch keys.shared.json && scripts/setup/setup-env-for-ci

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "zulu"

      - name: Install Facebook IDB
        run: |
          brew tap facebook/fb
          brew install idb-companion

      - name: Create and boot iPhone 17 Pro iOS 26.2 simulator
        run: |
          echo "üì± Creating iPhone 17 Pro simulator with iOS 26.2..."
          # Create the simulator
          SIMULATOR_UDID=$(xcrun simctl create "iPhone 17 Pro Test" com.apple.CoreSimulator.SimDeviceType.iPhone-17-Pro com.apple.CoreSimulator.SimRuntime.iOS-26-2)
          echo "Created simulator with UDID: $SIMULATOR_UDID"
          echo "SIMULATOR_UDID=$SIMULATOR_UDID" >> $GITHUB_ENV

          # Boot the simulator
          echo "üöÄ Booting simulator..."
          xcrun simctl boot "$SIMULATOR_UDID"

          # Wait for the simulator to be ready
          echo "‚è≥ Waiting for simulator to be ready..."
          WAIT_COUNT=0
          MAX_WAIT=60  # 60 iterations * 2 seconds = 120 seconds max wait
          while [[ $WAIT_COUNT -lt $MAX_WAIT ]]; do
            if xcrun simctl list devices | grep "$SIMULATOR_UDID" | grep -q "Booted"; then
              echo "‚úÖ Simulator is booted and ready!"
              break
            fi
            echo "Still waiting... (attempt $((WAIT_COUNT + 1))/$MAX_WAIT)"
            sleep 2
            WAIT_COUNT=$((WAIT_COUNT + 1))
          done

          if [[ $WAIT_COUNT -eq $MAX_WAIT ]]; then
            echo "‚ùå Timeout: Simulator failed to boot within 120 seconds"
            exit 1
          fi

          echo "üöÄ Bring simulator to foreground..."
          open -a simulator

      - name: Run Expo build for iOS
        run: |
          echo "üî® Building and running iOS app with Expo..."
          bundle exec npx expo run:ios --no-bundler
