name: Expo Fingerprint Check

on:
  push:
    branches:
      - gkartalis/build-cache-s3
  workflow_dispatch: # Allows manual trigger

jobs:
  check-fingerprint:
    runs-on: macos-15
    timeout-minutes: 10
    outputs:
      fingerprint_changed: ${{ steps.compare.outputs.changed }}
      current_fingerprint: ${{ steps.generate-fingerprint.outputs.fingerprint }}
      needs_build: ${{ steps.check-s3-cache.outputs.needs_build }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup JavaScript environment
        uses: ./.github/actions/setup-javascript-environment

      - name: Setup Ruby
        uses: ./.github/actions/setup-ruby

      - name: Setup iOS environment
        uses: ./.github/actions/setup-ios-environment

      - name: Download fonts from s3
        run: ./scripts/setup/download-fonts
        shell: bash

      - name: Download android assets
        run: ./scripts/setup/download-assets-android
        shell: bash

      - name: Generate current Expo fingerprint
        id: generate-fingerprint
        run: |
          echo "üìã Generating Expo fingerprint..."
          FINGERPRINT=$(npx @expo/fingerprint fingerprint:generate | jq -r '.hash')
          echo "Current fingerprint: $FINGERPRINT"
          echo "fingerprint=$FINGERPRINT" >> $GITHUB_OUTPUT

      - name: Generate debug fingerprint and upload to S3
        # Only run this step if the EXPO_FINGERPRINT_DEBUG secret is set to 'true'
        # you can find and change this in Eigen's GH repo under variables
        # https://github.com/artsy/eigen/settings/secrets/actions
        env:
          EXPO_FINGERPRINT_DEBUG: ${{ secrets.EXPO_FINGERPRINT_DEBUG }}
        if: env.EXPO_FINGERPRINT_DEBUG == 'true'
        run: |
          echo "üîç Generating debug fingerprint output..."
          npx @expo/fingerprint fingerprint:generate --debug > latest-debug.txt
          echo "üì§ Uploading debug fingerprint to S3..."
          aws s3 cp latest-debug.txt s3://artsy-citadel/eigen/expo-fingerprint/latest-debug.txt
          echo "‚úÖ Debug fingerprint saved"

      - name: Download previous fingerprint from S3
        id: download-fingerprint
        continue-on-error: true
        run: |
          echo "üì• Downloading previous fingerprint from S3..."
          aws s3 cp s3://artsy-citadel/eigen/expo-fingerprint/latest.txt ./previous-fingerprint.txt || echo "No previous fingerprint found"
          if [ -f previous-fingerprint.txt ]; then
            PREVIOUS=$(cat previous-fingerprint.txt)
            echo "Previous fingerprint: $PREVIOUS"
            echo "previous=$PREVIOUS" >> $GITHUB_OUTPUT
          else
            echo "previous=" >> $GITHUB_OUTPUT
          fi

      - name: Compare fingerprints
        id: compare
        run: |
          CURRENT="${{ steps.generate-fingerprint.outputs.fingerprint }}"
          PREVIOUS="${{ steps.download-fingerprint.outputs.previous }}"

          echo "üîç Comparing fingerprints..."
          echo "Current:  $CURRENT"
          echo "Previous: $PREVIOUS"

          if [ "$CURRENT" = "$PREVIOUS" ]; then
            echo "‚úÖ Fingerprints match - no native build needed"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "üîÑ Fingerprints differ - native builds required"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Check S3 for existing cached builds
        id: check-s3-cache
        run: |
          # If fingerprints match, no build is needed
          if [ "${{ steps.compare.outputs.changed }}" != "true" ]; then
            echo "‚úÖ Fingerprints match - no build needed"
            echo "needs_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          FINGERPRINT="${{ steps.generate-fingerprint.outputs.fingerprint }}"

          echo "üîç Checking S3 for existing builds with fingerprint: $FINGERPRINT"

          # Check if Android APK exists
          if aws s3api head-object --bucket artsy-citadel --key "eigen/cached-builds/${FINGERPRINT}.android.apk" 2>/dev/null; then
            echo "‚úÖ Found Android build in S3"
            ANDROID_EXISTS=true
          else
            echo "‚ùå Android build not found in S3"
            ANDROID_EXISTS=false
          fi

          # Check if iOS tar.gz exists
          if aws s3api head-object --bucket artsy-citadel --key "eigen/cached-builds/${FINGERPRINT}.ios.tar.gz" 2>/dev/null; then
            echo "‚úÖ Found iOS build in S3"
            IOS_EXISTS=true
          else
            echo "‚ùå iOS build not found in S3"
            IOS_EXISTS=false
          fi

          # Determine if we need to build
          if [ "$ANDROID_EXISTS" = "true" ] && [ "$IOS_EXISTS" = "true" ]; then
            echo "‚úÖ Both builds exist in S3 - no build needed"
            echo "needs_build=false" >> $GITHUB_OUTPUT
          else
            echo "üî® Builds missing in S3 - build required"
            echo "needs_build=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload new fingerprint to S3
        if: steps.compare.outputs.changed == 'true' && steps.check-s3-cache.outputs.needs_build == 'true'
        run: |
          echo "üì§ Uploading new fingerprint to S3..."
          echo "${{ steps.generate-fingerprint.outputs.fingerprint }}" > latest.txt
          aws s3 cp latest.txt s3://artsy-citadel/eigen/expo-fingerprint/latest.txt
          echo "‚úÖ Fingerprint saved"

      - name: Save needs_build output to artifact
        run: |
          echo "${{ steps.check-s3-cache.outputs.needs_build }}" > needs_build.txt

      - name: Upload needs_build artifact
        uses: actions/upload-artifact@v4
        with:
          name: needs_build
          path: needs_build.txt

  # ios-expo-build:
  #   needs: check-fingerprint
  #   if: needs.check-fingerprint.outputs.needs_build == 'true'
  #   runs-on: macos-15
  #   timeout-minutes: 90
  #   env:
  #     EXPO_BUILD_CACHE_UPLOAD: 1

  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     - name: Setup repository environment
  #       uses: ./.github/actions/setup-repo-environment
  #       with:
  #         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #     - name: Setup JavaScript environment
  #       uses: ./.github/actions/setup-javascript-environment

  #     - name: Setup Ruby
  #       uses: ./.github/actions/setup-ruby

  #     - name: Install Ruby dependencies
  #       run: bundle install

  #     - name: Setup iOS environment
  #       uses: ./.github/actions/setup-ios-environment

  #     - name: Set up env for ci
  #       run: touch .env.shared && touch keys.shared.json && scripts/setup/setup-env-for-ci

  #     - name: Set up JDK 17
  #       uses: actions/setup-java@v4
  #       with:
  #         java-version: "17"
  #         distribution: "zulu"

  #     - name: Install Facebook IDB
  #       run: |
  #         brew tap facebook/fb
  #         brew install idb-companion

  #     - name: Create and boot iPhone 17 Pro iOS 26.2 simulator
  #       run: |
  #         echo "üì± Creating iPhone 17 Pro simulator with iOS 26.2..."
  #         # Create the simulator
  #         SIMULATOR_UDID=$(xcrun simctl create "iPhone 17 Pro Test" com.apple.CoreSimulator.SimDeviceType.iPhone-17-Pro com.apple.CoreSimulator.SimRuntime.iOS-26-2)
  #         echo "Created simulator with UDID: $SIMULATOR_UDID"
  #         echo "SIMULATOR_UDID=$SIMULATOR_UDID" >> $GITHUB_ENV

  #         # Boot the simulator
  #         echo "üöÄ Booting simulator..."
  #         xcrun simctl boot "$SIMULATOR_UDID"

  #         # Wait for the simulator to be ready
  #         echo "‚è≥ Waiting for simulator to be ready..."
  #         WAIT_COUNT=0
  #         MAX_WAIT=60  # 60 iterations * 2 seconds = 120 seconds max wait
  #         while [[ $WAIT_COUNT -lt $MAX_WAIT ]]; do
  #           if xcrun simctl list devices | grep "$SIMULATOR_UDID" | grep -q "Booted"; then
  #             echo "‚úÖ Simulator is booted and ready!"
  #             break
  #           fi
  #           echo "Still waiting... (attempt $((WAIT_COUNT + 1))/$MAX_WAIT)"
  #           sleep 2
  #           WAIT_COUNT=$((WAIT_COUNT + 1))
  #         done

  #         if [[ $WAIT_COUNT -eq $MAX_WAIT ]]; then
  #           echo "‚ùå Timeout: Simulator failed to boot within 120 seconds"
  #           exit 1
  #         fi

  #         echo "üöÄ Bring simulator to foreground..."
  #         open -a simulator

  #     - name: Run Expo build for iOS
  #       run: |
  #         echo "üî® Building and running iOS app with Expo..."
  #         bundle exec npx expo run:ios --no-bundler

  android-expo-build:
    needs: check-fingerprint
    if: needs.check-fingerprint.outputs.needs_build == 'true'
    runs-on: ubuntu-latest # Use ubuntu-latest for better Android emulator support
    timeout-minutes: 60

    env:
      EXPO_BUILD_CACHE_UPLOAD: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download needs_build artifact
        uses: actions/download-artifact@v4
        with:
          name: needs_build
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Check if build is needed
        id: check-build
        run: |
          NEEDS_BUILD=$(cat needs_build.txt)
          echo "needs_build=$NEEDS_BUILD" >> $GITHUB_OUTPUT
          echo "Build needed: $NEEDS_BUILD"
          if [ "$NEEDS_BUILD" = "false" ]; then
            echo "‚úÖ Build not needed, exiting early"
            exit 0
          fi

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1.7"
          bundler-cache: true

      - name: Install Ruby dependencies
        run: bundle install

      - name: Setup JavaScript environment
        uses: ./.github/actions/setup-javascript-environment

      - name: Enable KVM group perms
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Set up env for ci
        run: touch .env.shared && touch keys.shared.json && scripts/setup/setup-env-for-ci

      - name: Run build with Android emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          ram-size: "8192M"
          heap-size: "4096M"
          disk-size: "10G"
          cores: 4
          disable-animations: false
          disable-spellchecker: true
          disable-linux-hw-accel: false
          enable-hw-keyboard: true
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          script: |
            echo "üîç Emulator started, verifying..."
            adb devices -l

            echo "üìã System info:"
            adb shell getprop ro.build.version.release
            adb shell getprop ro.build.version.sdk

            echo "üîì Unlocking device..."
            adb shell input keyevent 82

            echo "üî® Building and running Android app with Expo..."
            npx expo run:android
