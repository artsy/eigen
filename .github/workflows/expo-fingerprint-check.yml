name: Expo Fingerprint Check

on:
  push:
    branches:
      - gkartalis/build-cache-s3
  workflow_dispatch: # Allows manual trigger

jobs:
  check-fingerprint:
    runs-on: macos-15
    timeout-minutes: 10
    outputs:
      fingerprint_changed: ${{ steps.compare.outputs.changed }}
      current_fingerprint: ${{ steps.generate-fingerprint.outputs.fingerprint }}
      needs_build: ${{ steps.check-s3-cache.outputs.needs_build }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup JavaScript environment
        uses: ./.github/actions/setup-javascript-environment

      - name: Setup Ruby
        uses: ./.github/actions/setup-ruby

      - name: Setup iOS environment
        uses: ./.github/actions/setup-ios-environment

      - name: Download fonts from s3
        run: ./scripts/setup/download-fonts
        shell: bash

      - name: Download android assets
        run: ./scripts/setup/download-assets-android
        shell: bash

      - name: Generate current Expo fingerprint
        id: generate-fingerprint
        run: |
          echo "üìã Generating Expo fingerprint..."
          FINGERPRINT=$(npx @expo/fingerprint fingerprint:generate | jq -r '.hash')
          echo "Current fingerprint: $FINGERPRINT"
          echo "fingerprint=$FINGERPRINT" >> $GITHUB_OUTPUT

      - name: Generate debug fingerprint and upload to S3
        # Only run this step if the EXPO_FINGERPRINT_DEBUG secret is set to 'true'
        # you can find and change this in Eigen's GH repo under variables
        # https://github.com/artsy/eigen/settings/secrets/actions
        env:
          EXPO_FINGERPRINT_DEBUG: ${{ secrets.EXPO_FINGERPRINT_DEBUG }}
        if: env.EXPO_FINGERPRINT_DEBUG == 'true'
        run: |
          echo "üîç Generating debug fingerprint output..."
          npx @expo/fingerprint fingerprint:generate --debug > latest-debug.txt
          echo "üì§ Uploading debug fingerprint to S3..."
          aws s3 cp latest-debug.txt s3://artsy-citadel/eigen/expo-fingerprint/latest-debug.txt
          echo "‚úÖ Debug fingerprint saved"

      - name: Download previous fingerprint from S3
        id: download-fingerprint
        continue-on-error: true
        run: |
          echo "üì• Downloading previous fingerprint from S3..."
          aws s3 cp s3://artsy-citadel/eigen/expo-fingerprint/latest.txt ./previous-fingerprint.txt || echo "No previous fingerprint found"
          if [ -f previous-fingerprint.txt ]; then
            PREVIOUS=$(cat previous-fingerprint.txt)
            echo "Previous fingerprint: $PREVIOUS"
            echo "previous=$PREVIOUS" >> $GITHUB_OUTPUT
          else
            echo "previous=" >> $GITHUB_OUTPUT
          fi

      - name: Compare fingerprints
        id: compare
        run: |
          CURRENT="${{ steps.generate-fingerprint.outputs.fingerprint }}"
          PREVIOUS="${{ steps.download-fingerprint.outputs.previous }}"

          echo "üîç Comparing fingerprints..."
          echo "Current:  $CURRENT"
          echo "Previous: $PREVIOUS"

          if [ "$CURRENT" = "$PREVIOUS" ]; then
            echo "‚úÖ Fingerprints match - no native build needed"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "üîÑ Fingerprints differ - native builds required"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Check S3 for existing cached builds
        id: check-s3-cache
        run: |
          # If fingerprints match, no build is needed
          if [ "${{ steps.compare.outputs.changed }}" != "true" ]; then
            echo "‚úÖ Fingerprints match - no build needed"
            echo "needs_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          FINGERPRINT="${{ steps.generate-fingerprint.outputs.fingerprint }}"

          echo "üîç Checking S3 for existing builds with fingerprint: $FINGERPRINT"

          # Check if Android APK exists
          if aws s3api head-object --bucket artsy-citadel --key "eigen/cached-builds/${FINGERPRINT}.android.apk" 2>/dev/null; then
            echo "‚úÖ Found Android build in S3"
            ANDROID_EXISTS=true
          else
            echo "‚ùå Android build not found in S3"
            ANDROID_EXISTS=false
          fi

          # Check if iOS tar.gz exists
          if aws s3api head-object --bucket artsy-citadel --key "eigen/cached-builds/${FINGERPRINT}.ios.tar.gz" 2>/dev/null; then
            echo "‚úÖ Found iOS build in S3"
            IOS_EXISTS=true
          else
            echo "‚ùå iOS build not found in S3"
            IOS_EXISTS=false
          fi

          # Determine if we need to build
          if [ "$ANDROID_EXISTS" = "true" ] && [ "$IOS_EXISTS" = "true" ]; then
            echo "‚úÖ Both builds exist in S3 - no build needed"
            echo "needs_build=false" >> $GITHUB_OUTPUT
          else
            echo "üî® Builds missing in S3 - build required"
            echo "needs_build=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload new fingerprint to S3
        if: steps.compare.outputs.changed == 'true' && steps.check-s3-cache.outputs.needs_build == 'true'
        run: |
          echo "üì§ Uploading new fingerprint to S3..."
          echo "${{ steps.generate-fingerprint.outputs.fingerprint }}" > latest.txt
          aws s3 cp latest.txt s3://artsy-citadel/eigen/expo-fingerprint/latest.txt
          echo "‚úÖ Fingerprint saved"

      - name: Save needs_build output to artifact
        run: |
          echo "${{ steps.check-s3-cache.outputs.needs_build }}" > needs_build.txt

      - name: Upload needs_build artifact
        uses: actions/upload-artifact@v4
        with:
          name: needs_build
          path: needs_build.txt

  ios-expo-build:
    needs: check-fingerprint
    if: needs.check-fingerprint.outputs.needs_build == 'true'
    runs-on: macos-15
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup JavaScript environment
        uses: ./.github/actions/setup-javascript-environment

      - name: Setup Ruby
        uses: ./.github/actions/setup-ruby

      - name: Install Ruby dependencies
        run: bundle install

      - name: Setup iOS environment
        uses: ./.github/actions/setup-ios-environment

      - name: Set up env for ci
        run: touch .env.shared && touch keys.shared.json && scripts/setup/setup-env-for-ci

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "zulu"

      - name: Install Facebook IDB
        run: |
          brew tap facebook/fb
          brew install idb-companion

      - name: Create and boot iPhone 17 Pro iOS 26.2 simulator
        run: |
          echo "üì± Creating iPhone 17 Pro simulator with iOS 26.2..."
          # Create the simulator
          SIMULATOR_UDID=$(xcrun simctl create "iPhone 17 Pro Test" com.apple.CoreSimulator.SimDeviceType.iPhone-17-Pro com.apple.CoreSimulator.SimRuntime.iOS-26-2)
          echo "Created simulator with UDID: $SIMULATOR_UDID"
          echo "SIMULATOR_UDID=$SIMULATOR_UDID" >> $GITHUB_ENV

          # Boot the simulator
          echo "üöÄ Booting simulator..."
          xcrun simctl boot "$SIMULATOR_UDID"

          # Wait for the simulator to be ready
          echo "‚è≥ Waiting for simulator to be ready..."
          WAIT_COUNT=0
          MAX_WAIT=60  # 60 iterations * 2 seconds = 120 seconds max wait
          while [[ $WAIT_COUNT -lt $MAX_WAIT ]]; do
            if xcrun simctl list devices | grep "$SIMULATOR_UDID" | grep -q "Booted"; then
              echo "‚úÖ Simulator is booted and ready!"
              break
            fi
            echo "Still waiting... (attempt $((WAIT_COUNT + 1))/$MAX_WAIT)"
            sleep 2
            WAIT_COUNT=$((WAIT_COUNT + 1))
          done

          if [[ $WAIT_COUNT -eq $MAX_WAIT ]]; then
            echo "‚ùå Timeout: Simulator failed to boot within 120 seconds"
            exit 1
          fi

          echo "üöÄ Bring simulator to foreground..."
          open -a simulator

      - name: Run Expo build for iOS
        run: |
          echo "üî® Building and running iOS app with Expo..."
          bundle exec npx expo run:ios

  android-expo-build:
    needs: check-fingerprint
    if: needs.check-fingerprint.outputs.needs_build == 'true'
    runs-on: ubuntu-latest # Use ubuntu-latest for better Android emulator support
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup JavaScript environment
        uses: ./.github/actions/setup-javascript-environment

      - name: Setup Ruby
        uses: ./.github/actions/setup-ruby

      - name: Install Ruby dependencies
        run: bundle install

      - name: Setup Android environment
        uses: ./.github/actions/setup-android-environment

      - name: Set up env for ci
        run: touch .env.shared && touch keys.shared.json && scripts/setup/setup-env-for-ci

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "zulu"

      - name: Create and boot Android emulator
        run: |
          echo "üì± Creating Android emulator..."
          # Accept licenses first
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

          # Install system image if not present
          echo "üì• Installing system image..."
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "system-images;android-34;google_apis;arm64-v8a"

          # Create AVD
          echo "üî® Creating AVD..."
          echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
            -n test_emulator \
            -k "system-images;android-34;google_apis;arm64-v8a" \
            --force

          # Boot emulator
          echo "üöÄ Booting emulator..."
          $ANDROID_HOME/emulator/emulator -avd test_emulator -no-window -no-audio -no-boot-anim &

          # Wait for emulator to be ready
          echo "‚è≥ Waiting for emulator to be ready..."
          $ANDROID_HOME/platform-tools/adb wait-for-device

          # Wait for boot to complete
          WAIT_COUNT=0
          MAX_WAIT=60
          while [[ $WAIT_COUNT -lt $MAX_WAIT ]]; do
            BOOT_COMPLETED=$($ANDROID_HOME/platform-tools/adb shell getprop sys.boot_completed 2>&1 | tr -d '\r')
            if [[ "$BOOT_COMPLETED" == "1" ]]; then
              echo "‚úÖ Emulator is booted and ready!"
              break
            fi
            echo "Still waiting... (attempt $((WAIT_COUNT + 1))/$MAX_WAIT)"
            sleep 2
            WAIT_COUNT=$((WAIT_COUNT + 1))
          done

          if [[ $WAIT_COUNT -eq $MAX_WAIT ]]; then
            echo "‚ùå Timeout: Emulator failed to boot within 120 seconds"
            exit 1
          fi

      - name: Run Expo build for Android
        run: |
          echo "üî® Building and running Android app with Expo..."
          bundle exec npx expo run:android
