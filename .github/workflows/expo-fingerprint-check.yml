name: Expo Fingerprint Check

on:
  push:
    branches:
      - gkartalis/build-cache-s3
      - main
  workflow_dispatch: # Allows manual trigger

jobs:
  check-fingerprint:
    runs-on: macos-15
    timeout-minutes: 10
    outputs:
      fingerprint_changed: ${{ steps.compare.outputs.changed }}
      current_fingerprint: ${{ steps.generate-fingerprint.outputs.fingerprint }}
      needs_ios_build: ${{ steps.check-s3-cache.outputs.needs_ios_build }}
      needs_android_build: ${{ steps.check-s3-cache.outputs.needs_android_build }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup JavaScript environment
        uses: ./.github/actions/setup-javascript-environment

      - name: Setup Ruby
        uses: ./.github/actions/setup-ruby

      - name: Setup iOS environment
        uses: ./.github/actions/setup-ios-environment

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: gradle-v2-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-v2-${{ runner.os }}-

      - name: Download android assets
        run: ./scripts/setup/download-assets-android
        shell: bash

      - name: Generate current Expo fingerprint
        id: generate-fingerprint
        run: |
          echo "ðŸ“‹ Generating Expo fingerprint..."
          FINGERPRINT=$(npx @expo/fingerprint fingerprint:generate | jq -r '.hash')
          echo "Current fingerprint: $FINGERPRINT"
          echo "fingerprint=$FINGERPRINT" >> $GITHUB_OUTPUT

      - name: Generate debug fingerprint and upload to S3
        # Only run this step if the EXPO_FINGERPRINT_DEBUG secret is set to 'true'
        # you can find and change this in Eigen's GH repo under variables
        # https://github.com/artsy/eigen/settings/secrets/actions
        env:
          EXPO_FINGERPRINT_DEBUG: ${{ secrets.EXPO_FINGERPRINT_DEBUG }}
        if: env.EXPO_FINGERPRINT_DEBUG == 'true'
        run: |
          echo "ðŸ” Generating debug fingerprint output..."
          npx @expo/fingerprint fingerprint:generate --debug > latest-debug.txt
          echo "ðŸ“¤ Uploading debug fingerprint to S3..."
          aws s3 cp latest-debug.txt s3://mobile-cached-builds/eigen-expo-fingerprint/latest-debug.txt
          echo "âœ… Debug fingerprint saved"

      - name: Download previous fingerprint from S3
        id: download-fingerprint
        continue-on-error: true
        run: |
          echo "ðŸ“¥ Downloading previous fingerprint from S3..."
          aws s3 cp s3://mobile-cached-builds/eigen-expo-fingerprint/latest.txt ./previous-fingerprint.txt || echo "No previous fingerprint found"
          if [ -f previous-fingerprint.txt ]; then
            PREVIOUS=$(cat previous-fingerprint.txt)
            echo "Previous fingerprint: $PREVIOUS"
            echo "previous=$PREVIOUS" >> $GITHUB_OUTPUT
          else
            echo "previous=" >> $GITHUB_OUTPUT
          fi

      - name: Compare fingerprints
        id: compare
        run: |
          CURRENT="${{ steps.generate-fingerprint.outputs.fingerprint }}"
          PREVIOUS="${{ steps.download-fingerprint.outputs.previous }}"

          echo "ðŸ” Comparing fingerprints..."
          echo "Current:  $CURRENT"
          echo "Previous: $PREVIOUS"

          if [ "$CURRENT" = "$PREVIOUS" ]; then
            echo "âœ… Fingerprints match - no native build needed"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ”„ Fingerprints differ - native builds required"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Check S3 for existing cached builds
        id: check-s3-cache
        run: |
          # If fingerprints match, no build is needed for either platform
          if [ "${{ steps.compare.outputs.changed }}" != "true" ]; then
            echo "âœ… Fingerprints match - no build needed"
            echo "needs_ios_build=false" >> $GITHUB_OUTPUT
            echo "needs_android_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          FINGERPRINT="${{ steps.generate-fingerprint.outputs.fingerprint }}"

          echo "ðŸ” Checking S3 for existing builds with fingerprint: $FINGERPRINT"

          # Check if Android tar.gz exists
          if aws s3api head-object --bucket artsy-citadel --key "eigen/cached-builds/${FINGERPRINT}.android.tar.gz" 2>/dev/null; then
            echo "âœ… Found Android build in S3"
            echo "needs_android_build=false" >> $GITHUB_OUTPUT
          else
            echo "âŒ Android build not found in S3 - build required"
            echo "needs_android_build=true" >> $GITHUB_OUTPUT
          fi

          # Check if iOS tar.gz exists
          if aws s3api head-object --bucket artsy-citadel --key "eigen/cached-builds/${FINGERPRINT}.ios.tar.gz" 2>/dev/null; then
            echo "âœ… Found iOS build in S3"
            echo "needs_ios_build=false" >> $GITHUB_OUTPUT
          else
            echo "âŒ iOS build not found in S3 - build required"
            echo "needs_ios_build=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload new fingerprint to S3
        if: steps.compare.outputs.changed == 'true' && (steps.check-s3-cache.outputs.needs_ios_build == 'true' || steps.check-s3-cache.outputs.needs_android_build == 'true')
        run: |
          echo "ðŸ“¤ Uploading new fingerprint to S3..."
          echo "${{ steps.generate-fingerprint.outputs.fingerprint }}" > latest.txt
          aws s3 cp latest.txt s3://mobile-cached-builds/eigen-expo-fingerprint/latest.txt
          echo "âœ… Fingerprint saved"

      - name: Save needs_ios_build output to artifact
        run: |
          echo "${{ steps.check-s3-cache.outputs.needs_ios_build }}" > needs_ios_build.txt

      - name: Upload needs_ios_build artifact
        uses: actions/upload-artifact@v4
        with:
          name: needs_ios_build
          path: needs_ios_build.txt

      - name: Save needs_android_build output to artifact
        run: |
          echo "${{ steps.check-s3-cache.outputs.needs_android_build }}" > needs_android_build.txt

      - name: Upload needs_android_build artifact
        uses: actions/upload-artifact@v4
        with:
          name: needs_android_build
          path: needs_android_build.txt
