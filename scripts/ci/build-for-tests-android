#!/usr/bin/env bash
set -exo pipefail

# Configure ccache environment variables if not already set
if command -v ccache >/dev/null 2>&1 && [ -z "${CCACHE_DIR+x}" ]; then
  export CCACHE_DIR=~/.ccache
  export CCACHE_MAXSIZE=5G
  export NDK_CCACHE=/usr/bin/ccache
  export CCACHE_CPP2=yes
  export CCACHE_SLOPPINESS=pch_defines,time_macros,include_file_mtime
  
  # Log ccache stats before build
  ccache -z
  ccache -s
fi

pushd android
# Run the build with ccache enabled in the gradle.properties
yarn react-native build-android --mode=release --extra-params='--max-workers 2'
popd

# Log ccache stats after build
if command -v ccache >/dev/null 2>&1; then
  ccache -s
fi
