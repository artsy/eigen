#!/usr/bin/env bash
set -euxo pipefail

BUILD_TYPE=${1:-debug}
if [ "$BUILD_TYPE" == "qa" ]; then
	echo "Building iOS App in QA mode"
	CONFIGURATION="QA"
else
	echo "Building iOS App in Debug mode"
	CONFIGURATION="Debug"
fi

cd build-cache-provider && npx tsc && cd ..

# Ensure xcode-select is pointing to the correct Xcode
sudo xcode-select -s /Applications/Xcode.app

# Export DEVELOPER_DIR to ensure Expo can find Xcode
export DEVELOPER_DIR=/Applications/Xcode.app/Contents/Developer

# Verify xcode-select is set correctly
echo "Xcode path: $(xcode-select -p)"

# Verify Simulator.app exists
if [ -d "/Applications/Xcode.app/Contents/Developer/Applications/Simulator.app" ]; then
	echo "Simulator.app found"
else
	echo "WARNING: Simulator.app not found at expected location"
fi

# Wait for simulator to be ready (it's pre-booted in CI)
echo "Waiting for simulator to be ready..."
xcrun simctl list devices | grep -q "Booted" && echo "Simulator is booted" || echo "No booted simulator found"

# Get the booted simulator UDID
SIMULATOR_UDID=$(xcrun simctl list devices | grep "Booted" | grep -E -o -i "([0-9a-f]{8}-([0-9a-f]{4}-){3}[0-9a-f]{12})" | head -1)
if [ -n "$SIMULATOR_UDID" ]; then
	echo "Using simulator: $SIMULATOR_UDID"
else
	echo "No booted simulator found"
fi

# Debug: Check environment before running expo
echo "=== Debugging Simulator Detection ==="
echo "DEVELOPER_DIR: $DEVELOPER_DIR"
echo "xcode-select path: $(xcode-select -p)"
echo "Simulator.app exists: $([ -d "/Applications/Xcode.app/Contents/Developer/Applications/Simulator.app" ] && echo "YES" || echo "NO")"
echo "Simulator.app bundle ID: $(defaults read /Applications/Xcode.app/Contents/Developer/Applications/Simulator.app/Contents/Info.plist CFBundleIdentifier 2>&1 || echo "FAILED TO READ")"
echo "xcrun simctl path: $(which xcrun)"
echo "Available simulators:"
xcrun simctl list devices available | grep "iPhone" | head -5
echo "Booted simulators:"
xcrun simctl list devices | grep "Booted" || echo "None"
echo "====================================="

# Run expo without --device flag to let it auto-detect the booted simulator
echo "Running expo run:ios..."
DEVELOPER_DIR=/Applications/Xcode.app/Contents/Developer bundle exec npx expo run:ios