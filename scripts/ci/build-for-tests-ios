#!/usr/bin/env bash
set -euxo pipefail

# Configure ccache environment variables if not already set
if command -v ccache >/dev/null 2>&1 && [ -z "${CCACHE_DIR+x}" ]; then
  export CCACHE_DIR=~/.ccache
  export CCACHE_MAXSIZE=5G
  export CC="ccache clang"
  export CXX="ccache clang++"
  export CCACHE_CPP2=yes
  export CCACHE_SLOPPINESS=pch_defines,time_macros,include_file_mtime
  
  # Log ccache stats before build
  ccache -z
  ccache -s
fi

# Run the build with ccache enabled
xcodebuild -workspace "$WORKSPACE" -scheme "$SCHEME" -configuration Debug -sdk iphonesimulator build -destination platform="$DEVICE_HOST_PLAT",OS="$DEVICE_HOST_OS",name="$DEVICE_HOST_NAME" -derivedDataPath "$DERIVED_DATA_PATH" GCC_PREPROCESSOR_DEFINITIONS='$(inherited)' |
	tee ./xcode_build_raw.log |
	bundle exec xcpretty -c

# Log ccache stats after build
if command -v ccache >/dev/null 2>&1; then
  ccache -s
fi
