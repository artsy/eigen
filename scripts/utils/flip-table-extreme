#!/usr/bin/env bash
set -euxo pipefail

# When to use this script:
#
# Use this script when you want to do a COMPLETE NUCLEAR clean of your development environment.
# This is the most aggressive repair option and should only be used when you are experiencing
# persistent issues that are not resolved by the standard `yarn repair` script.
#
# Use this when:
# - yarn repair didn't fix the issue
# - You have deep caching issues across global caches
# - Native dependency conflicts that won't resolve
# - Relay or GraphQL codegen issues
# - You've been using a locally linked palette-mobile package
#
# This script does EVERYTHING that yarn clean does, PLUS:
# - Cleans global yarn & pod caches
# - Clears relay and GraphQL caches
# - Resets yalc linked packages (palette-mobile)
# - Clears build artifacts
#
# For most issues, try `yarn repair` first. Only use this when necessary.

# Clear global and local caches and build files
echo 'Clean global yarn & pod caches (â”›âœ§Ğ”âœ§))â”›å½¡â”»â”â”»'
yarn cache clean
bundle exec pod cache clean --all

# Clear local gradle caches and build files
echo 'Clear gradle cache'
if [ -d node_modules ]; then
	cd android
	./gradlew clean
	cd -
fi

rm -rf android/.gradle
rm -rf android/build
rm -rf android/app/build

echo 'Clear JS caches (â”›à² _à² )â”›å½¡â”»â”â”»'
rm -rf .cache

echo 'Clear gems (â”›à² _à² )â”›å½¡â”»â”â”»'
rm -rf .vendor

echo 'Clear node modules (â”›à² _à² )â”›å½¡â”»â”â”»'
rm -rf node_modules

echo 'Clear cocoapods directory (ãƒà² ç›Šà² )ãƒå½¡â”»â”â”»'
rm -rf Pods

echo 'Clear Xcode derived data (â•¯Â°â–¡Â°)â•¯ï¸µ â”»â”â”»'
# sometimes this fails on first try even with -rf
# but a second try takes it home
if ! rm -rf ~/Library/Developer/Xcode/DerivedData; then
	rm -rf ~/Library/Developer/Xcode/DerivedData
fi

echo 'Clear Xcode generated .env (â•¯Â°â–¡Â°)â•¯ï¸µ â”»â”â”»'
rm -rf ios/.xcode.env.local

echo 'Reset yalc linked packages (ï¾‰à² Ğ´à² )ï¾‰ï¸µâ”»â”â”»'
if command -v yalc &> /dev/null
then
	yalc remove @artsy/palette-mobile
fi

echo 'Clear relay, relay query map, jest, and metro caches (â”›â—‰Ğ”â—‰)â”›å½¡â”»â”â”»'
rm -rf "${TMPDIR%/}"/RelayFindGraphQLTags-*
rm -rf data/complete.queryMap.json
rm -rf .cache
rm -rf "${TMPDIR%/}"/metro-*
rm -rf "${TMPDIR%/}"/haste-map-*
rm -rf src/__generated__/*.graphql.ts


echo 'Clear build artifacts (â•¯à²° ~ à²°ï¼‰â•¯ï¸µ â”»â”â”»'
find dist/ ! -name '.gitkeep' -type f -exec rm -f {} +

echo "Reset watchman (ãƒà² ç›Šà² )ãƒå½¡â”»â”â”»"
watchman watch-del .

echo "Re-enable watchman ğŸ‘€"
watchman watch-project .

echo 'Setup Assets'
# Required for yarn 4
yarn install
yarn setup:artsy

echo 'Reinstall dependencies â”¬â”€â”¬ãƒ( Âº _ Âºãƒ)'
yarn install:all
