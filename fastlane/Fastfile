require 'yaml'

lane :ship_beta do
  verify_pod_keys

  readme_yaml = File.read("../CHANGELOG.yml")
  readme_data = YAML.load(readme_yaml)

  latest_version = readme_data["upcoming"]["version"]

  upcoming = readme_data["upcoming"]
  beta_readme =  "## #{upcoming["version"]} \n\n - #{upcoming["notes"].join "\n - "} \n\n"

  match type: "appstore"

  # This would have been generated by `make ipa`
  ipa_path = "build/Artsy.ipa"

  # Ship to hockey first, testflight has to wait: "processing"
  hockey notes: beta_readme, api_token: ENV['HOCKEY_API_TOKEN'], public_identifier: ENV['HockeyAppLiveID'], ipa: ipa_path
  pilot changelog: beta_readme, ipa: ipa_path

  slack message: "There is a new Eigen beta available. Grab it from Testflight on your iOS device.",
        channel: "artsy-ios",
        payload: {
          'Version' => latest_version,
          'What\'s new' => beta_readme
        },
        default_payloads: []
end
